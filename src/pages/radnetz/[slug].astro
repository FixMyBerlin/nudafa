---
import LayoutApp from '@components/layouts/LayoutApp.astro'
import { navHeightClassAsNegativeMarginBottom } from '@components/layouts/navbar/Navbar'
import TextLinkArrow from '@components/links/TextLinkArrow.astro'
import { RadnetzArticleWrapperDesktop } from '@components/page_radnetz/RadnetzArticleWrapperDesktop'
import { RadnetzArticleWrapperMobile } from '@components/page_radnetz/RadnetzArticleWrapperMobile'
import { RadnetzImprintPrivacy } from '@components/page_radnetz/RadnetzImprintPrivacy'
import { RadnetzMap } from '@components/page_radnetz/RadnetzMap'
import { RadnetzNavMobileAndDesktop } from '@components/page_radnetz/RadnetzNav'
import type { RadnetzPage } from '@components/page_radnetz/types'
import { getCollection } from 'astro:content'
import clsx from 'clsx'

const rawPages = await getCollection('bicyclenetworkpages')
const sortedPages = rawPages.sort((a, b) => a.data.order - b.data.order)
const pages: RadnetzPage[] = []
for (const page of sortedPages) {
  const { Content } = await page.render()
  pages.push({
    slug: page.slug,
    menu: page.data.menu,
    order: page.data.order,
    title: page.data.title,
    links: page.data.links,
    Content: Content,
  })
}

export async function getStaticPaths() {
  // This catch-all renders our React components which navigates with client side routing .
  // However the first page load will use the static generated page.
  // Props like the page title will only update on the initial page load or a page reload.
  const rawPages = await getCollection('bicyclenetworkpages')
  return rawPages.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }))
}

const { entry } = Astro.props
const { title, links } = entry.data
---

<LayoutApp title={title}>
  <!-- navHeightClassAsNegativeMarginBottom makes RadnetzNav 'max h-screen minus height of Navbar' possible -->
  <div
    class={clsx('relative h-full w-full md:flex md:flex-row', navHeightClassAsNegativeMarginBottom)}
  >
    <RadnetzNavMobileAndDesktop client:load articleSlug={entry.slug} pages={pages} />
    <RadnetzMap articleSlug={entry.slug} client:load />

    {
      pages.map(({ slug, title, Content }) => (
        <>
          <RadnetzArticleWrapperDesktop client:load articleSlug={slug} title={title} links={links}>
            <Content
              components={{
                TextLinkArrow,
              }}
            />
          </RadnetzArticleWrapperDesktop>
          <RadnetzArticleWrapperMobile client:load articleSlug={slug} title={title} links={links}>
            <Content
              components={{
                TextLinkArrow,
              }}
            />
          </RadnetzArticleWrapperMobile>
        </>
      ))
    }
  </div>
  <RadnetzImprintPrivacy className="md:hidden" />
</LayoutApp>
